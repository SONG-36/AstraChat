# 代码详细设计文档（Source Code Detailed Design Document）

**Document Version:** 1.0
**Status:** Draft
**Author:** Andy
**Project Name:** AstraChat — AWS Serverless AI Customer Service Demo

## 1 引言（Introduction）

本文件为 AstraChat 项目对应的 **代码级详细设计文档**（Code-Level Design），用于从源码结构维度进一步描述：

- 目录结构设计（Project Folder Structure）
- 文件划分方案（File Responsibility）
- 函数级接口设计（Function-Level Design）
- 公共库与工具封装（Common Utilities）
- 部署与运行方式（Lambda Packaging / Web Build）
- 与组件设计文档（LLD）的对应关系

本设计将严格对应：

- **3.1 Chat Widget**
- **3.2 Chat API**

并为后续实现提供统一的代码蓝图。

## 2 项目整体代码结构（Project Source Structure）

以下展示项目的整体代码结构草案，后续章节中会逐一详细展开。

```txt
AstraChat/
│
├── frontend/ # 前端代码（Chat Widget + 演示页）
│ └── chat_widget/
│ ├── index.js
│ ├── widget.css
│ ├── api_client.js
│ ├── session.js
│ └── components/
│ ├── MessageBubble.js
│ └── LoadingIndicator.js
│
├── backend/ # 后端代码（Lambda + API）
│ ├── chat_api/ # 3.2 Chat API Lambda
│ │ ├── handler.py
│ │ ├── validator.py
│ │ ├── rag_client.py
│ │ ├── llm_client.py
│ │ ├── models.py
│ │ ├── config.py
│ │ └── utils/
│ │ ├── logger.py
│ │ └── error_handler.py
│ │
│ └── common/ # 公共工具 & 模型
│ ├── aws_clients.py
│ ├── prompt_builder.py
│ ├── constants.py
│ └── retry.py
│
└── infrastructure/ # IaC （CDK / Terraform）
├── cdk.json
├── app.py
└── stacks/
└── api_stack.py
```

## 3 Chat Widget 代码设计（Frontend Code Design）

Chat Widget 是 AstraChat 的前端核心交互组件。本章将详细说明其代码结构、文件设计、类与函数接口、状态管理方案及与后端 API 的联动方式。

### 3.1 目录结构（Folder Structure）

```txt
frontend/chat_widget/
│
├── index.js # 入口文件，挂载 Widget
├── widget.css # 样式文件
├── api_client.js # 与 Chat API 通信
├── session.js # session_id 管理
├── state.js # 状态管理（loading/error）
└── components/
├── MessageBubble.js # 消息气泡组件
└── LoadingIndicator.js# 加载组件
```

**目录结构说明**

| 文件                           | 职责                                              |
| ------------------------------ | ------------------------------------------------- |
| index.js                       | 初始化 widget、绑定 DOM、加载样式、集成所有子模块 |
| api_client.js                  | 实现 fetch 调用、超时、重试、错误处理             |
| session.js                     | 统一管理 session_id（localStorage）               |
| state.js                       | 管理 UI 状态（loading / error / history）         |
| components/MessageBubble.js    | 气泡 UI                                           |
| components/LoadingIndicator.js | 加载 UI                                           |

### 3.2 index.js 设计（入口文件）

**职责**

- 创建聊天窗口 HTML 结构
- 初始化事件监听（输入框、发送按钮）
- 整合 session、api_client、组件
- 渲染消息列表

**代码骨架**

```c
import { sendMessageToAPI } from "./api_client.js";
import { getSessionId } from "./session.js";
import { renderMessage, renderLoading } from "./components/MessageBubble.js";


class ChatWidget {
constructor(config) {
this.apiUrl = config.apiUrl;
this.sessionId = getSessionId();
this.container = null;
}


mount(selector) {
this.container = document.querySelector(selector);
this.container.innerHTML = this._buildUI();
this._bindEvents();
}


async _onSend() {
const input = this.container.querySelector("#chat-input");
const text = input.value;
if (!text) return;


renderMessage(text, "user");
renderLoading();


const reply = await sendMessageToAPI(this.apiUrl, this.sessionId, text);
renderMessage(reply, "assistant");
}


_bindEvents() {
const btn = this.container.querySelector("#chat-send");
btn.addEventListener("click", () => this._onSend());
}


_buildUI() {
return `
<div class="astra-chatbox">
<div id="messages"></div>
<div class="chat-input-row">
<input id="chat-input" placeholder="Type a message..." />
<button id="chat-send">Send</button>
</div>
</div>`;
}
}


export default ChatWidget;
```

### 3.3 api_client.js 设计（网络请求模块）

**功能**

- 调用后端 Chat API
- 自动带上 session_id
- 管理重试、超时

**代码骨架**

```java
export async function sendMessageToAPI(apiUrl, sessionId, message) {
try {
const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), 10000);


const res = await fetch(apiUrl, {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ session_id: sessionId, message }),
signal: controller.signal
});


clearTimeout(timeout);


if (!res.ok) {
throw new Error(`HTTP Error ${res.status}`);
}


const data = await res.json();
return data.reply;
} catch (err) {
return "抱歉，服务器暂时不可用，请稍后再试。";
}
}
```

### 3.4 session.js（Session 管理）

```java
export function getSessionId() {
let id = localStorage.getItem("astra_session");
if (!id) {
id = crypto.randomUUID();
localStorage.setItem("astra_session", id);
}
return id;
}
```

### 3.5 UI 组件设计（MessageBubble、LoadingIndicator）

**MessageBubble.js**

```java
export function renderMessage(text, role) {
const msgBox = document.querySelector("#messages");
const el = document.createElement("div");
el.className = `msg msg-${role}`;
el.innerText = text;
msgBox.appendChild(el);
}
```

**LoadingIndicator.js**

```java
export function renderLoading() {
const msgBox = document.querySelector("#messages");
const el = document.createElement("div");
el.className = "loading";
el.innerText = "…";
msgBox.appendChild(el);
}
```



